do ->
  # $resourceをインジェクション
  app = angular.module('MyRoutesApp', ['ngResource', 'ngRoute'])

  # Rails CSRFトークンを使用するように設定
  app.config ['$httpProvider', ($httpProvider) ->
    $httpProvider.defaults.headers.common['X-CSRF-Token'] = $('meta[name=csrf-token]').attr('content');
    $httpProvider.defaults.headers.common['X-Requested-With'] = "XMLHttpRequest"
  ]

  # ルーティングの設定
  app.config ['$routeProvider', ($routeProvider) ->
    $routeProvider.when('/', {
      templateUrl: 'list.html',
      controller: 'ListController'
    }).when('/route/:id', {
      templateUrl: 'route.html',
      controller: 'RouteController'
    }).when('/route/new', {
      templateUrl: 'route_detail.html',
      controller: 'RouteDetailController'
    }).when('/route/:id/edit', {
      templateUrl: 'route_detail.html',
      controller: 'RouteDetailController'
    }).otherwise({
      redirectTo: '/'
    })
  ]

  # Routesテーブルに対するRESTfullのマッパーを定義
  app.factory('Routes', ['$resource', ($resource) ->
    $resource('/routes/:id.json', {id: '@id'})
  ])

  # Coordinatesテーブルに対するRESTfullのマッパーを定義
  app.factory('Coordinates', ['$resource', ($resource) ->
    $resource('/coordinates/:id.json', {id: '@id'})
  ])

  # 一覧画面のコントローラ
  app.controller('ListController', ['$scope', 'Routes',
    ($scope, Routes) ->
      $scope.routes = Routes.query()
  ])

  # 地図表示画面のコントローラ
  app.controller('RouteController', ['$scope', '$routeParams', 'Routes',
    ($scope, $routeParams, Routes) ->
      $scope.route = Routes.get({id: $routeParams.id})
      console.log($scope.route)
  ])

  # ルート編集画面のコントローラ
  app.controller('RouteDetailController', ['$scope', '$routeParams', 'Routes', 'Coordinates',
    ($scope, $routeParams, Routes, Coordinates) ->
      if $$routeParams.id?
        $scope.route = Routes.get({id: $routeParams.id})
      else
        $scope.route = {
          title: '',
          description: '',
          coordinates: []
        }
  ])